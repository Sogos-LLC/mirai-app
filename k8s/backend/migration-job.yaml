apiVersion: batch/v1
kind: Job
metadata:
  name: mirai-db-migrate
  namespace: mirai
  labels:
    app: mirai-migrate
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: mirai-migrate
    spec:
      restartPolicy: OnFailure
      tolerations:
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule
      dnsPolicy: None
      dnsConfig:
        nameservers:
          - 169.254.20.10
          - 10.96.0.10
        searches:
          - mirai.svc.cluster.local
          - svc.cluster.local
          - cluster.local
        options:
          - name: ndots
            value: "2"
          - name: timeout
            value: "3"
          - name: attempts
            value: "5"
      containers:
      - name: migrate
        image: ghcr.io/sogos-llc/mirai-app/mirai-backend:latest
        imagePullPolicy: Always
        command: ["./migrate", "-direction", "up"]
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: mirai-db-secret
              key: dsn
        - name: MIGRATIONS_PATH
          value: "file:///app/migrations"
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "200m"
        securityContext:
          runAsNonRoot: true
          runAsUser: 10000
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          seccompProfile:
            type: RuntimeDefault
