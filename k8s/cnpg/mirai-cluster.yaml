---
# CloudNativePG Cluster for Mirai Application Database
# High-Availability PostgreSQL with Zero Data Loss (RPO=0)
# Leverages 10Gbps/MTU9000 fabric for synchronous replication
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: mirai-db
  namespace: mirai
  labels:
    app.kubernetes.io/name: mirai-db
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: mirai
spec:
  description: "Mirai Application Database - HA PostgreSQL Cluster"
  imageName: ghcr.io/cloudnative-pg/postgresql:16.4

  # 3 instances - one per Mac Mini node for HA
  instances: 3

  # Primary update strategy
  primaryUpdateStrategy: unsupervised
  primaryUpdateMethod: switchover

  # Synchronous replication for Zero Data Loss (RPO=0)
  # With 10Gbps fabric, sync replication has negligible latency penalty
  minSyncReplicas: 1
  maxSyncReplicas: 2

  # PostgreSQL configuration
  postgresql:
    parameters:
      # CRITICAL: Synchronous commit for RPO=0
      synchronous_commit: "on"

      # Performance tuning for Mac Mini (64GB RAM)
      shared_buffers: "8GB"
      effective_cache_size: "24GB"
      maintenance_work_mem: "2GB"
      work_mem: "512MB"

      # WAL settings for sync replication
      wal_level: "replica"
      max_wal_senders: "10"
      max_replication_slots: "10"
      wal_keep_size: "2GB"

      # Checkpoints
      checkpoint_completion_target: "0.9"
      checkpoint_timeout: "15min"

      # Connection settings
      max_connections: "200"

      # Logging
      log_statement: "ddl"
      log_min_duration_statement: "1000"

    pg_hba:
      - host all all 10.0.0.0/8 scram-sha-256
      - host all all 192.168.0.0/16 scram-sha-256

  # Bootstrap configuration
  bootstrap:
    initdb:
      database: mirai
      owner: mirai
      secret:
        name: mirai-db-credentials
      postInitSQL:
        - CREATE EXTENSION IF NOT EXISTS "uuid-ossp"

  # Storage configuration - LOCAL NVMe via local-path
  storage:
    storageClass: local-path
    size: 20Gi

  # WAL storage on same local-path for performance
  walStorage:
    storageClass: local-path
    size: 5Gi

  # Resource allocation - generous for 64GB Mac Minis
  resources:
    requests:
      cpu: "1"
      memory: "12Gi"
    limits:
      cpu: "4"
      memory: "16Gi"

  # Affinity - spread across nodes with tolerations for control-plane
  affinity:
    enablePodAntiAffinity: true
    topologyKey: kubernetes.io/hostname
    podAntiAffinityType: required
    tolerations:
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule

  # Monitoring
  monitoring:
    enablePodMonitor: true

  # Backup configuration - NAS destination for WAL archives
  backup:
    barmanObjectStore:
      destinationPath: "s3://cnpg-backups/mirai"
      endpointURL: "http://192.168.1.226:9768"
      s3Credentials:
        accessKeyId:
          name: cnpg-backup-credentials
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: cnpg-backup-credentials
          key: ACCESS_SECRET_KEY
      wal:
        compression: gzip
        maxParallel: 4
      data:
        compression: gzip
    retentionPolicy: "7d"

  # Replication settings
  replicationSlots:
    highAvailability:
      enabled: true
    updateInterval: 30

  # Switchover delay for graceful failover
  switchoverDelay: 60

  # Stop delay before SIGKILL
  stopDelay: 300

  # Smart shutdown timeout
  smartShutdownTimeout: 180
---
# Scheduled backup - daily full backup to NAS
apiVersion: postgresql.cnpg.io/v1
kind: ScheduledBackup
metadata:
  name: mirai-db-daily-backup
  namespace: mirai
spec:
  schedule: "0 2 * * *"  # 2 AM daily
  backupOwnerReference: self
  cluster:
    name: mirai-db
  immediate: false
  suspend: false
