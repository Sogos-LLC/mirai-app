global
    log stdout format raw local0 debug
    maxconn 4096

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option forwardfor
    timeout connect 10s
    timeout client 300s
    timeout server 300s
    # Disable buffering for streaming
    option http-buffer-request

frontend https_front
    bind *:8443 ssl crt /etc/haproxy/certs/server.pem alpn h2,http/1.1

    # Enable HTTP/2
    # Log detailed info for debugging
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"

    # ACLs for routing
    acl is_grpc path_beg /mirai.v1.
    acl is_health path_beg /health
    acl is_api path_beg /api/v1/
    acl is_kratos path_beg /api/kratos/

    # Route to backends
    use_backend backend_api if is_grpc
    use_backend backend_api if is_health
    use_backend backend_api if is_api
    use_backend kratos_api if is_kratos
    default_backend frontend_app

backend backend_api
    # Use HTTP/2 to backend (h2c - cleartext)
    server backend host.docker.internal:8080 proto h2

    # Disable response buffering for streaming
    option http-no-delay
    http-request disable-l7-retry

    # Long timeouts for streaming
    timeout server 300s
    timeout tunnel 300s

backend kratos_api
    # Strip /api/kratos prefix
    http-request set-path %[path,regsub(^/api/kratos,)]
    server kratos host.docker.internal:4433

backend frontend_app
    server frontend host.docker.internal:3000

# Stats page for debugging
frontend stats
    bind *:8404
    stats enable
    stats uri /
    stats refresh 10s
    stats admin if TRUE
